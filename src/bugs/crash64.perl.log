#include "unicruft.h"
#include <stdio.h>
#include <errno.h>
#include <stdlib.h>

void munge_file(FILE *f) {
  uxBuffer ibuf = {NULL,0,0};
  uxBuffer pbuf = {NULL,0,0};
  uxBuffer obuf = {NULL,0,0};
  uxDEpp   depp;

  ux_buffer_slurp_file(&ibuf,f);

  ux_depp_init(&depp);
  ux_depp_scan_const_buffer(&depp, &ibuf, &pbuf);
  ux_unidecode_us(&UNIDECODE_LATIN1, &pbuf, &obuf);

  //ux_buffer_fwrite(&obuf, stdout);

  //-- cleanup
  if (ibuf.str) free(ibuf.str);
  if (pbuf.str) free(pbuf.str);
  if (obuf.str) free(obuf.str);
  ux_depp_free_data(&depp);
}

int main(int argc, char **argv) {
  int i;
  FILE *f;
  if (argc <= 1) {
    fprintf(stderr, "Usage: %s FILE(s)...\n", argv[0]);
    exit(1);
  }
  for (i=1; i < argc; i++) {
    fprintf(stderr, "%s\n", argv[i]);
    if (strcmp(argv[i],"-")==0) {
      f = stdin;
    } else {
      f = fopen(argv[i],"r");
    }
    if (f==NULL) {
      fprintf(stderr, "%s: open failed for '%s': %s\n", argv[0],argv[i],strerror(errno));
      exit(1);
    }
    munge_file(f);
    if (f!=stdin) fclose(f);
  }
  return 0;
}
